---
suite: Test templates/configmap.yaml
templates:
  - charts/airflow/templates/configmaps/configmap.yaml
tests:
  - it: should work
    asserts:
      - isKind:
          of: ConfigMap
  - it: should use our default for airflowLocalSettings
    set:
      airflow:
        podMutation:
          tolerations:
            - somekey: somevalue
          affinity:
            anotherkey: anothervalue
    asserts:
      - matchRegex:
          path: data.airflow_local_settings\.py
          pattern: '{"somekey":"somevalue"}'
      - matchRegex:
          path: data.airflow_local_settings\.py
          pattern: '{"anotherkey":"anothervalue"}'
  - it: should still be settable
    set:
      airflow:
        podMutation:
          tolerations:
            - somekey: somevalue
        airflowLocalSettings: "# well hello"
    asserts:
      - matchRegex:
          path: data.airflow_local_settings\.py
          pattern: "# well hello"
      - notMatchRegex:
          path: data.airflow_local_settings\.py
          pattern: '{"somekey":"somevalue"}'
  - it: should use default auth_backend value deny_all
    asserts:
      - matchRegex:
          path: data.airflow\.cfg
          pattern: "airflow.api.auth.backend.deny_all"
  - it: should use fab security auth_backend value when useAstroSecurityManager is enabled
    set:
      airflow:
        useAstroSecurityManager: true
    asserts:
      - matchRegex:
          path: data.airflow\.cfg
          pattern: "astronomer.flask_appbuilder.current_user_backend"
