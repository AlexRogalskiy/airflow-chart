#! /usr/bin/env bash
set -e

if [[ -z "${KUBE_VERSION}" ]]; then
  export KUBE_VERSION='1.15.6'
fi

# Create a kind cluster
kind create cluster --image kindest/node:v${KUBE_VERSION}

echo "Installing service account..."
# Update the service account for tiller to work.
kubectl create serviceaccount --namespace kube-system tiller
kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
echo "Installing Tiller in the cluster..."
helm init --service-account tiller --upgrade --wait
echo "Tiller installed."

echo "Deploying postgresql..."
helm install -n postgresql --namespace default --wait \
  --set image.tag=9.6.15-centos-7-r34 \
  --set postgresqlPassword=notactuallysecret \
  stable/postgresql > /dev/null 2>&1

export POSTGRES_PASSWORD=$(kubectl get secret --namespace default postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode)
export DB_CONNECTION_STRING="postgres://postgres:${POSTGRES_PASSWORD}@postgresql.default:5432"
kubectl create secret generic astronomer-bootstrap \
  --from-literal connection=$DB_CONNECTION_STRING \
  --namespace default
echo "Postgresql deployed."

echo "Making certs"
mkcert -install
mkcert -cert-file /tmp/fullchain.pem -key-file /tmp/privkey.pem app.local.astronomer-development.com local.astronomer-development.com "*.local.astronomer-development.com"
cat "$(mkcert -CAROOT)/rootCA.pem" >> /tmp/fullchain.pem

echo "Installing TLS cert and private key"
kubectl create secret tls astronomer-tls \
  --key /tmp/privkey.pem \
  --cert /tmp/fullchain.pem
